# TODO

## Tier 1 – Data and Subscription
- [ ] Add a migration for `position_trackers` with the columns used by `PositionTracker` (order number, security ID, entry price, P&L/HWM fields, status timestamps). The current schema only defines instruments, derivatives, settings, and watchlist tables, so the trailing-stop state cannot persist yet.【F:app/models/position_tracker.rb†L5-L60】【F:db/schema.rb†L13-L138】
- [ ] Align `Live::MarketFeedHub` with the spec by running the WebSocket in `:full` mode and seeding a baseline watchlist (NIFTY, BANKNIFTY, SENSEX) when no database watchlist exists. Right now the hub defaults to `:quote` mode and simply echoes whatever WatchlistItem rows happen to be present.【F:app/services/live/market_feed_hub.rb†L10-L147】
- [ ] Introduce a Rails configuration object (`config.x.dhanhq`) that mirrors the environment flags (`DHANHQ_ENABLED`, `DHANHQ_WS_ENABLED`, etc.) so that the Dhan client and both WebSocket hubs can safely read `enabled?`/`ws_enabled` without raising `NoMethodError`. At present the client assumes `config.x.dhanhq` exists, while the initializer only loads credentials into the SDK.【F:app/services/dhanhq/client.rb†L15-L143】【F:config/initializers/dhanhq_config.rb†L1-L13】

## Tier 2 – Risk Management Loop
- [ ] Start the order fill bridge and trailing-stop loop during boot. `config/initializers/market_stream.rb` launches the feed hubs and OHLC prefetcher, but it never calls `Live::OrderUpdateHandler.start!` or the risk loop entry point (`Live::RiskManagerService.start!`/`start_loop!`), so fills are not promoted to `:active` and the 5-second enforcement thread never runs.【F:config/initializers/market_stream.rb†L3-L23】【F:app/services/live/order_update_handler.rb†L7-L60】【F:app/services/live/risk_manager_service.rb†L7-L112】
- [x] Introduced a persistence layer for broker fills via `BrokerOrder`, wired the WebSocket handler to upsert order status/quantities, and now promote trackers off the persisted payload before risk monitoring picks them up.【F:app/models/broker_order.rb†L1-L83】【F:app/services/live/order_update_handler.rb†L7-L59】【F:db/migrate/20251004090000_create_broker_orders.rb†L1-L26】

## Tier 3 – Trading Intelligence and Execution
- [ ] Implement the Phase II Quantitative layer: add a `Quant::TrendIdentifier` singleton that consumes the instrument helpers (`instrument.candle_series`, `instrument.supertrend_signal`, `instrument.rsi`) instead of re-fetching candles manually. The current `Trading::TrendIdentifier` talks directly to `Trading::DataFetcherService` and local indicator helpers, so the spec’s reusable QIS entry point is still missing.【F:app/services/trading/trend_identifier.rb†L5-L45】
- [ ] Flesh out the strike bridge in `Quant::StrikeSelector`: fetch the option chain for the upcoming expiry, apply the liquidity filters, then resolve the winning strike back to a local `Derivative` row so we obtain the broker-required `security_id`. The existing `Trading::StrikeSelector` only picks the numerically closest strike from preloaded derivatives and never inspects Option Chain data.【F:app/services/trading/strike_selector.rb†L5-L35】【F:app/models/instrument.rb†L23-L68】
- [ ] Promote `TradingWorker` to the Sidekiq worker described in Phase II (custom queue, `retry: false`, `perform(index_symbol)`), and wire an external scheduler to enqueue it every 5 minutes. The current implementation inherits from `ApplicationJob`, takes no instrument argument, and therefore cannot target the per-index trading cycle defined in the spec.【F:app/jobs/trading_worker.rb†L1-L9】
- [ ] Finish the EMS orchestration inside `TradingService`: enforce the global pyramid limit via `DhanHQ::Models::Position.active`, pick the strike through the QIS selector, compute quantity from available funds and live LTP (`TickCache`), and submit the Super Order through `DhanHQ::Models::SuperOrder.create`. The present service loops over every enabled instrument, re-checks `PositionTracker` counts only, and delegates to a thin client wrapper without the broker-facing capital and quantity logic.【F:app/services/trading/trading_service.rb†L6-L98】
