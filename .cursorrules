{
  "rules": [
    {
      "name": "Rails Backend Standards",
      "type": "always",
      "content": "All Ruby files MUST start with `# frozen_string_literal: true` as the first line.\n\nControllers MUST be placed under `app/controllers/api/` and namespaced under `Api::` module. All controllers MUST inherit from `ApplicationController < ActionController::API`. Controllers MUST be thin - business logic MUST be in services, not controllers. Controllers MUST use `render json:` for all responses (no serializers).\n\nServices MUST be organized by domain in `app/services/domain/` subdirectories: signal/, options/, capital/, entries/, orders/, live/, risk/, indicators/. Services with lifecycle (start/stop) MUST inherit from `TradingSystem::BaseService`. Stateless utility services MUST inherit from `ApplicationService` and implement `.call(*, **, &)` class method. Services managing global state MUST use `include Singleton` and be accessed via `.instance` class method.\n\nModels MUST be placed in `app/models/` with concerns in `app/models/concerns/`. All models MUST inherit from `ApplicationRecord < ActiveRecord::Base`. Shared model logic MUST use concerns. Status/type fields MUST use `enum`, never string constants. Scopes MUST be defined as class methods. All associations MUST specify `dependent:` options.\n\nShared utilities MUST be placed in `lib/`, never in `app/`. Provider abstractions MUST be in `lib/providers/`. Rake tasks MUST be in `lib/tasks/`.\n\nCode style: Always use 2 spaces for indentation, never tabs. Never exceed 120 characters per line (exceptions: comments, describe/context/it/expect patterns). Never exceed 30 lines per method (exceptions: spec files). All files MUST pass RuboCop checks before commit.\n\nTarget Ruby version: 3.3.4 (enforced via `.ruby-version`)."
    },
    {
      "name": "Node Backend Standards",
      "type": "always",
      "content": "Not applicable - this is a Rails-only API application with no Node.js backend."
    },
    {
      "name": "React + TypeScript Standards",
      "type": "always",
      "content": "Not applicable - this is a Rails API-only application with no frontend code."
    },
    {
      "name": "Database Standards",
      "type": "always",
      "content": "Migration files MUST be named with timestamp prefix: `YYYYMMDDHHMMSS_descriptive_name.rb`. Migrations MUST use `ActiveRecord::Migration[8.0]` version. Migrations MUST use `def change` method, never `up`/`down` unless necessary. Migrations MUST be reversible (idempotent). Migrations MUST add indexes with descriptive names. Composite unique indexes MUST use descriptive names ending with `_unique`. Partial indexes MUST use `where:` clause when filtering NULL values.\n\nAll tables MUST have `created_at` and `updated_at` timestamps. Decimal columns MUST specify `precision` and `scale`. Foreign keys MUST be explicitly added with `add_foreign_key`. NOT NULL constraints MUST be specified for required fields. Default values MUST be specified for status fields and numeric columns. JSONB columns MUST be used for flexible metadata (`meta`, `metadata`). Polymorphic associations MUST use `_type` and `_id` suffix pattern.\n\nUnique constraints MUST be enforced via composite unique indexes. Partial indexes MUST be used with `where:` clauses for filtered queries. GIN indexes MUST be used for JSONB columns that are queried. Composite indexes MUST be created for common multi-column queries. Index names MUST follow pattern: `index_table_name_on_columns`.\n\nTable names MUST be plural. Column names MUST use `snake_case`. Foreign key columns MUST end with `_id`. Polymorphic type columns MUST end with `_type`."
    },
    {
      "name": "Testing Standards (RSpec)",
      "type": "always",
      "content": "Test files MUST be named `*_spec.rb` and placed in `spec/` directory. Test structure MUST mirror `app/` directory structure. Tests MUST use RSpec framework (not Minitest). Test files MUST require `rails_helper.rb`. Tests MUST use FactoryBot for test data creation.\n\n`describe` blocks MUST use `.` or `::` for class methods, `#` for instance methods. `context` blocks MUST start with: `when`, `with`, `without`, `if`, `unless`, `for`, `that`. Spec descriptions MUST NOT exceed 40 characters (split using contexts). Nested groups (describe/context) MUST NOT exceed 5 levels. Example length MUST NOT exceed 25 lines (exceptions: features, integration, system specs). Multiple memoized helpers (`let`) MUST NOT exceed 10 per spec. Multiple expectations MUST NOT exceed 4 per test (exceptions: integration, system, feature specs). Always use `expect` syntax, never `should` syntax.\n\nFactories MUST be defined in `spec/factories/` directory. Factory attributes MUST be defined statically. Factories MUST use traits for variations (e.g., `:nifty_index`, `:banknifty_future`). Factory names MUST match model names in singular form.\n\nTests MUST use DatabaseCleaner with transaction strategy. Tests MUST clean database with truncation before suite. Tests MUST use VCR for external API call recording/playback. Tests MUST filter sensitive data from VCR cassettes. Tests MUST mock external API calls (DhanHQ) for reliability. Tests MUST disable DhanHQ in test environment via `ENV['DHANHQ_ENABLED'] = 'false'`. Tests MUST use WebMock for HTTP stubbing. Tests MUST use transactional fixtures disabled (`use_transactional_fixtures = false`).\n\nIntegration tests MUST be placed in `spec/integration/` directory. Integration tests MAY have multiple expectations and exceed 25 lines (excluded from respective rules)."
    },
    {
      "name": "API Standards",
      "type": "always",
      "content": "All API endpoints MUST be under `/api` namespace. Routes MUST be defined in `config/routes.rb` under `namespace :api`. Health check endpoint MUST be at `/api/health`. API responses MUST use JSON format only.\n\nControllers MUST use `render json:` for all responses. Responses MUST be plain JSON objects (no serializers). Responses MUST use inline hash construction in controllers. Error responses MUST include error message and status. Success responses MUST include relevant data and status indicators.\n\nCORS MUST be configured via `rack-cors` middleware. CORS MUST allow all origins in development (restrict in production)."
    },
    {
      "name": "Error & Logging Standards",
      "type": "always",
      "content": "Exception Handling:\nServices MUST rescue `StandardError` explicitly, never bare `rescue`. Error handling MUST log errors with class context: `[ClassName] Error message`. Error logging MUST include exception class and message: `#{e.class} - #{e.message}`. Services MUST return `nil` or error hash on failure, never raise exceptions to callers. Custom errors MUST be defined as classes inheriting from `StandardError`. Error messages MUST be descriptive and include context.\n\nRetry Logic:\nRetry logic MUST be implemented in services when needed. Retry attempts MUST have maximum count defined as a constant (e.g., `RETRY_COUNT = 3`). Retry logic MUST use exponential backoff or fixed delay. Retry logic MUST log retry attempts.\n\nGraceful Degradation:\nServices MUST handle missing data gracefully (return `nil` or empty collections). Services MUST validate inputs before processing. Services MUST handle external API failures without crashing.\n\nLogging:\nAll log messages MUST include class context in brackets: `[ClassName] Message`. Log messages MUST use structured format: `[ClassName] Action description`. Error logs MUST include exception details: `[ClassName] #{e.class} - #{e.message}`. Debug logs MUST be commented out in production code (use `# Rails.logger.debug`).\n\nLog Levels:\n`Rails.logger.info` MUST be used for normal operations. `Rails.logger.warn` MUST be used for warnings. `Rails.logger.error` MUST be used for errors. `Rails.logger.debug` MUST be used for debug information (commented in production).\n\nLog Context:\nLog messages MUST include relevant context (index key, order ID, etc.). Log messages MUST be concise but descriptive. Sensitive data MUST NOT be logged (filtered via `filter_parameter_logging.rb`).\n\nProduction Logging:\nProduction logs MUST use tagged logging with `:request_id`. Production logs MUST output to STDOUT. Production log level MUST be configurable via `RAILS_LOG_LEVEL` environment variable. Health check endpoints MUST be silenced in logs (`silence_healthcheck_path`)."
    },
    {
      "name": "Architecture Rules",
      "type": "always",
      "content": "Domain Organization:\nServices MUST be organized by domain in subdirectories. Domain boundaries MUST be respected (no cross-domain dependencies). Shared logic MUST be extracted to concerns or base classes.\n\nService Patterns:\nBusiness logic MUST be in services, not controllers or models. Controllers MUST only handle request/response. Models MUST only handle data persistence and validations. Services MUST be PORO (Plain Old Ruby Objects).\n\nConfiguration:\nTrading parameters MUST be configurable via `config/algo.yml`. Environment-specific config MUST use environment variables. Configuration MUST be loaded via `AlgoConfig.fetch`. Secrets MUST be stored in encrypted credentials or environment variables.\n\nReal-time Services:\nReal-time services (WebSocket, market feeds) MUST use Singleton pattern. Singleton services MUST manage their own threads. Thread names MUST be descriptive (e.g., `'signal-scheduler'`, `'pnl-updater-service'`). Thread safety MUST be ensured via mutexes when needed.\n\nExternal Integrations:\nExternal API clients MUST be abstracted via provider classes in `lib/providers/`. External API calls MUST be wrapped in error handling. External API credentials MUST be loaded from environment variables.\n\nPerformance:\nString matching MUST use `start_with?`/`end_with?` instead of regex when possible. String prefix/suffix removal MUST use `delete_prefix`/`delete_suffix`. Cache keys MUST use descriptive prefixes: `option_chain:`, `tick:`. Cache MUST be checked for staleness before use. Singleton services MUST be used for in-memory caches. Queries MUST use appropriate indexes. N+1 queries MUST be avoided (use `includes`/`joins`). Bulk operations MUST use `activerecord-import` for large datasets."
    },
    {
      "name": "Naming Conventions",
      "type": "always",
      "content": "Files:\nFile names MUST use `snake_case.rb`. Service files MUST be named `service_name.rb` in `app/services/domain/`. Model files MUST be named `model_name.rb` in `app/models/`. Controller files MUST be named `resource_controller.rb` in `app/controllers/api/`. Test files MUST be named `*_spec.rb` in `spec/`.\n\nClasses and Modules:\nClass names MUST use `CamelCase`. Module names MUST use `CamelCase`. Namespaced classes MUST use `::` separator: `Domain::ServiceName`. Service classes MUST have descriptive names: `Signal::Engine`, `Capital::Allocator`. Job classes MUST have action-oriented names: `SyncPricesJob`.\n\nMethods:\nMethod names MUST use `snake_case`. Predicate methods MUST end with `?`: `running?`, `active?`. Destructive methods MUST end with `!`: `save!`, `update!`. Class methods MUST be called via `.` or `::`.\n\nConstants:\nConstants MUST use `SCREAMING_SNAKE_CASE`. Constants MUST be defined at class/module level. Magic numbers MUST be extracted to named constants.\n\nVariables:\nVariable names MUST use `snake_case`. Instance variables MUST use `@variable_name`. Class variables MUST be avoided (use class instance variables instead).\n\nDatabase:\nTable names MUST be plural: `instruments`, `position_trackers`. Column names MUST use `snake_case`. Foreign key columns MUST end with `_id`: `instrument_id`. Polymorphic type columns MUST end with `_type`: `watchable_type`. Index names MUST follow pattern: `index_table_name_on_columns`."
    },
    {
      "name": "Git Workflow",
      "type": "always",
      "content": "Commit Messages:\nCommit messages MUST use imperative mood: `Add feature`, `Fix bug`, `Update config`. Commit message first line MUST NOT exceed 72 characters. Commit messages MUST NOT use CamelCase (use imperative summaries). Commit messages MUST be descriptive and explain what and why.\n\nPull Requests:\nPRs MUST include clear description of changes and purpose. PRs MUST link to tracking issues if applicable. PRs MUST include verification steps: `bin/rubocop` (code style), `bin/brakeman` (security scan), `bin/rails test` (test suite). PRs MUST mention schema or config impacts. PRs MUST include request/response samples for API changes. PRs MUST be small and reviewable (prefer small changes). PRs MUST focus on single feature or bug fix. PRs MUST include tests for new functionality. PRs MUST update relevant documentation.\n\nBranch Naming:\nBranch names MUST be descriptive and use kebab-case. Feature branches SHOULD start with `feature/`. Bug fix branches SHOULD start with `fix/`."
    },
    {
      "name": "Documentation Standards",
      "type": "always",
      "content": "Code Documentation:\nComplex logic MUST be documented with comments. Public API methods MUST be documented with YARD-style comments when needed. TODO comments MUST use format: `# TODO: Description`. NOTE comments MUST use format: `# NOTE: Description`. HACK comments MUST be avoided (refactor instead).\n\nMarkdown Documentation:\nDocumentation files MUST use `.md` extension. Level-one and level-two headings MUST use Title Case. Sequential procedures MUST be numbered. Environment variables or configuration MUST be documented in tables. Critical warnings MUST use blockquotes starting with `> **Warning:**`. Documentation lines MUST be under 90 characters per line for readable diffs.\n\nREADME:\nREADME MUST include project overview, setup instructions, and usage examples. README MUST document all environment variables in a table. README MUST include troubleshooting section. README MUST link to additional documentation.\n\nAPI Documentation:\nAPI endpoints MUST be documented with HTTP method, path, and example response. API documentation MUST include request/response examples in JSON format."
    },
    {
      "name": "Security Standards",
      "type": "always",
      "content": "Secrets Management:\nSecrets MUST be stored in `config/credentials.yml.enc` (Rails encrypted credentials). `config/master.key` MUST NEVER be committed to version control. API keys MUST be loaded from environment variables. Environment variables MUST be used for DhanHQ credentials. Support both naming conventions: `CLIENT_ID` or `DHAN_CLIENT_ID`, and `ACCESS_TOKEN` or `DHAN_ACCESS_TOKEN`. Application code MUST check both variants: `ENV['DHAN_CLIENT_ID'] || ENV['CLIENT_ID']` and `ENV['DHAN_ACCESS_TOKEN'] || ENV['ACCESS_TOKEN']`. The initializer normalizes these to `CLIENT_ID` and `ACCESS_TOKEN` for the DhanHQ gem. Production deployments MUST supply `RAILS_MASTER_KEY` environment variable.\n\nParameter Filtering:\nSensitive parameters MUST be filtered from logs via `filter_parameter_logging.rb`. Filtered parameters MUST include: `passw`, `email`, `secret`, `token`, `_key`, `crypt`, `salt`, `certificate`, `otp`, `ssn`, `cvv`, `cvc`. VCR cassettes MUST filter sensitive data (access tokens, client IDs).\n\nSSL/TLS:\nProduction MUST force SSL: `force_ssl = true`. Production MUST assume SSL: `assume_ssl = true`.\n\nInput Validation:\nAll external inputs MUST be validated. Database queries MUST use parameterized statements (ActiveRecord handles this). User inputs MUST be sanitized before use.\n\nTesting Security:\nTests MUST disable external API calls in test environment. Tests MUST use VCR to record/playback external API calls. VCR cassettes MUST filter sensitive data before recording."
    },
    {
      "name": "Nemesis Architect Mode",
      "type": "always",
      "content": "When generating or refactoring code, always think like a production-grade systems architect:\n\n1. Production Readiness: Every change MUST consider production implications. Error handling MUST be comprehensive. Logging MUST be structured and traceable. Performance MUST be considered (N+1 queries, caching, thread safety).\n\n2. Trading System Safety: This is a financial trading system - errors can cost money. Always validate inputs. Always handle external API failures gracefully. Always log trading decisions. Never raise exceptions that could crash the trading loop. Always use idempotent operations for order placement.\n\n3. Code Quality: Code MUST pass RuboCop before commit. Code MUST have appropriate test coverage. Code MUST follow domain-driven design principles. Business logic MUST be in services, never in controllers or models.\n\n4. Observability: All critical operations MUST be logged with class context. Health endpoints MUST reflect actual system state. Thread names MUST be descriptive for debugging. Singleton services MUST provide health/status methods.\n\n5. Maintainability: Code MUST be self-documenting with clear naming. Complex logic MUST have comments explaining the \"why\". Domain boundaries MUST be respected. Shared logic MUST be extracted to concerns or base classes.\n\n6. Security: Never commit secrets. Always use environment variables for credentials. Always filter sensitive data from logs. Always validate external inputs.\n\n7. Performance: Always consider caching for expensive operations. Always use appropriate database indexes. Always avoid N+1 queries. Always use bulk operations for large datasets.\n\n8. Testing: Tests MUST use VCR for external API calls. Tests MUST disable external services in test environment. Tests MUST use FactoryBot with traits. Tests MUST follow Better Specs guidelines.\n\nWhen in doubt, prioritize safety, observability, and maintainability over cleverness or brevity."
    }
  ]
}

