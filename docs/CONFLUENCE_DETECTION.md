# Confluence Detection in Modular Indicator System

## Overview

The modular indicator system now includes **confluence detection** - a feature that shows how many indicators agree on a signal direction and provides detailed breakdown of indicator alignment.

## What is Confluence?

Confluence in trading refers to when multiple indicators or signals align/agree on the same direction. The more indicators that agree, the stronger the signal. This helps filter out weak signals and identify high-probability setups.

## Confluence Information

Every signal generated by `MultiIndicatorStrategy` now includes confluence data:

```ruby
{
  type: :ce,                    # Signal type
  confidence: 75,               # Combined confidence score
  confluence: {
    score: 80,                  # Confluence score (0-100): % of indicators agreeing
    strength: :strong,          # :strong, :moderate, :weak, :none
    total_indicators: 5,        # Total number of indicators
    bullish_count: 4,           # Number of bullish indicators
    bearish_count: 1,           # Number of bearish indicators
    neutral_count: 0,           # Number of neutral indicators
    dominant_direction: :bullish, # Dominant direction
    agreeing_count: 4,          # Number agreeing with dominant direction
    breakdown: [                # Detailed breakdown per indicator
      {
        name: 'supertrend',
        direction: :bullish,
        confidence: 80,
        agrees: true            # Whether this indicator agrees with dominant direction
      },
      {
        name: 'adx',
        direction: :bullish,
        confidence: 75,
        agrees: true
      },
      {
        name: 'rsi',
        direction: :bearish,
        confidence: 60,
        agrees: false           # This indicator disagrees
      }
      # ... more indicators
    ]
  }
}
```

## Confluence Score

The confluence score is calculated as:
```
confluence_score = (agreeing_indicators / total_indicators) * 100
```

**Example:**
- 5 indicators total
- 4 indicators agree on bullish direction
- Confluence score = (4/5) * 100 = 80%

## Confluence Strength Levels

| Score Range | Strength | Meaning |
|------------|----------|---------|
| 80-100% | `:strong` | Strong confluence - most indicators agree |
| 60-79% | `:moderate` | Moderate confluence - majority agrees |
| 40-59% | `:weak` | Weak confluence - mixed signals |
| 0-39% | `:none` | No confluence - indicators disagree |

## Usage Examples

### Example 1: Strong Confluence (All Indicators Agree)

```ruby
strategy = MultiIndicatorStrategy.new(
  series: series,
  indicators: [
    { type: 'supertrend', config: { period: 7 } },
    { type: 'adx', config: { period: 14 } },
    { type: 'rsi', config: { period: 14 } },
    { type: 'macd', config: {} },
    { type: 'trend_duration', config: {} }
  ],
  confirmation_mode: :all
)

signal = strategy.generate_signal(index)
# signal[:confluence][:score] = 100
# signal[:confluence][:strength] = :strong
# All 5 indicators agree → Very high probability signal
```

### Example 2: Moderate Confluence (Majority Agrees)

```ruby
# 3 out of 5 indicators agree
# signal[:confluence][:score] = 60
# signal[:confluence][:strength] = :moderate
# signal[:confluence][:breakdown] shows which 3 agree and which 2 disagree
```

### Example 3: Weak Confluence (Mixed Signals)

```ruby
# 2 out of 5 indicators agree
# signal[:confluence][:score] = 40
# signal[:confluence][:strength] = :weak
# Mixed signals - may want to avoid or wait for better confluence
```

## Integration with Signal::Engine

When using the multi-indicator system via `Signal::Engine`, confluence information is automatically logged:

```
[Signal] Confluence for NIFTY: score=80% strength=strong (4/5 indicators agree on bullish)
[Signal]   ✓ supertrend: bullish (confidence: 80)
[Signal]   ✓ adx: bullish (confidence: 75)
[Signal]   ✓ rsi: bullish (confidence: 70)
[Signal]   ✓ macd: bullish (confidence: 65)
[Signal]   ✗ trend_duration: bearish (confidence: 60)
```

The confluence data is also included in the analysis result:

```ruby
result = Signal::Engine.analyze_with_multi_indicators(...)
result[:confluence] # Contains full confluence information
```

## Using Confluence for Filtering

You can use confluence strength to filter signals:

```ruby
signal = strategy.generate_signal(index)

if signal && signal[:confluence][:strength] == :strong
  # High probability signal - proceed with entry
  # All or most indicators agree
elsif signal && signal[:confluence][:strength] == :moderate
  # Moderate probability - proceed with caution
  # Majority agrees but some disagree
else
  # Weak or no confluence - skip or wait
  # Mixed signals, low probability
end
```

## Confluence vs Confirmation Modes

**Confluence** and **Confirmation Modes** work together but serve different purposes:

- **Confirmation Modes** (`all`, `majority`, `weighted`, `any`): Determine **if** a signal is generated based on indicator agreement rules
- **Confluence**: Provides **detailed information** about how indicators agree/disagree, regardless of whether a signal was generated

**Example:**
- Confirmation mode `all` requires all indicators to agree → signal generated
- Confluence shows: "5/5 indicators agree (100% score, strong confluence)"
- This provides transparency and helps with debugging/optimization

## Benefits

1. **Transparency**: See exactly which indicators agree/disagree
2. **Signal Quality**: Filter signals by confluence strength
3. **Debugging**: Understand why signals were/weren't generated
4. **Optimization**: Identify which indicator combinations work best
5. **Risk Management**: Avoid low-confluence signals (mixed indicators)

## Best Practices

1. **Strong Confluence (80%+)**: High-probability setups - proceed with normal position sizing
2. **Moderate Confluence (60-79%)**: Good setups - proceed but consider slightly reduced sizing
3. **Weak Confluence (40-59%)**: Mixed signals - wait for better confluence or skip
4. **No Confluence (<40%)**: Avoid - indicators disagree, low probability

## Configuration

Confluence is automatically calculated for all signals. No additional configuration needed. The confluence information is always included in signal results when using `MultiIndicatorStrategy`.

## Example Output

```ruby
{
  type: :ce,
  confidence: 75,
  confluence: {
    score: 80,
    strength: :strong,
    total_indicators: 5,
    bullish_count: 4,
    bearish_count: 1,
    neutral_count: 0,
    dominant_direction: :bullish,
    agreeing_count: 4,
    breakdown: [
      { name: 'supertrend', direction: :bullish, confidence: 80, agrees: true },
      { name: 'adx', direction: :bullish, confidence: 75, agrees: true },
      { name: 'rsi', direction: :bullish, confidence: 70, agrees: true },
      { name: 'macd', direction: :bullish, confidence: 65, agrees: true },
      { name: 'trend_duration', direction: :bearish, confidence: 60, agrees: false }
    ]
  }
}
```

This shows that 4 out of 5 indicators agree on bullish direction (80% confluence, strong), with trend_duration being the outlier.
