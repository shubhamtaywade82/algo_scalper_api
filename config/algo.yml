paper_trading:
  enabled: true
  balance: 100000

feature_flags:
  enable_direction_before_chain: true
  enable_trend_scorer: false # Toggle TrendScorer on/off (if false, uses legacy Supertrend+ADX path)
  enable_auto_subscribe_unsubscribe: true
  enable_demand_driven_services: true
  enable_underlying_aware_exits: false
  enable_peak_drawdown_activation: false
  auto_paper_on_insufficient_balance: false

# ============================================
# INDEX CONFIG (TREND-SCORE DRIVEN)
# ============================================
indices:
  - key: NIFTY
    segment: IDX_I
    sid: "13"
    capital_alloc_pct: 0.30
    max_same_side: 1
    cooldown_sec: 180
    direction: bullish

    premium_band:
      min: 30
      max: 120

    otm_rules:
      max_otm: 2 # ATM → +1 OTM → +2 OTM

    risk_model:
      base_risk_pct: 0.01 # 1% base
      strong_trend_pct: 0.01
      weak_trend_pct: 0.005

    trade_limits:
      max_trades_per_day: 3

    # Per-index ADX thresholds (overrides global if specified)
    adx_thresholds:
      primary_min_strength: 14 # 1m ADX threshold (70% of typical ~20)
      confirmation_min_strength: 11 # 5m ADX threshold (70% of typical ~15.5)

    strategies:
      open_interest:
        enabled: true
        priority: 1
      momentum_buying:
        enabled: true
        priority: 2
        min_rsi: 60
      btst:
        enabled: true
        priority: 3
      swing_buying:
        enabled: true
        priority: 4

  - key: BANKNIFTY
    segment: IDX_I
    sid: "25"
    capital_alloc_pct: 0.30
    max_same_side: 1
    cooldown_sec: 180
    direction: bullish

    premium_band:
      min: 60
      max: 180

    otm_rules:
      max_otm: 2

    risk_model:
      base_risk_pct: 0.02 # 2% base
      strong_trend_pct: 0.02
      weak_trend_pct: 0.01

    trade_limits:
      max_trades_per_day: 1

    # Per-index ADX thresholds (overrides global if specified)
    adx_thresholds:
      primary_min_strength: 18 # 1m ADX threshold (use global default)
      confirmation_min_strength: 31 # 5m ADX threshold (70% of typical ~44)

    strategies:
      open_interest:
        enabled: true
        priority: 1
      momentum_buying:
        enabled: true
        priority: 2
        min_rsi: 60
      btst:
        enabled: true
        priority: 3
      swing_buying:
        enabled: true
        priority: 4

  - key: SENSEX
    segment: IDX_I
    sid: "51"
    capital_alloc_pct: 0.30
    max_same_side: 1
    cooldown_sec: 180
    direction: bullish

    premium_band:
      min: 40
      max: 150

    otm_rules:
      max_otm: 2

    risk_model:
      base_risk_pct: 0.005 # 0.5% base
      strong_trend_pct: 0.005
      weak_trend_pct: 0.0025

    trade_limits:
      max_trades_per_day: 2

    # Per-index ADX thresholds (overrides global if specified)
    adx_thresholds:
      primary_min_strength: 18 # 1m ADX threshold (70% of typical ~25.5)
      confirmation_min_strength: 10 # 5m ADX threshold (70% of typical ~13.5)

    strategies:
      open_interest:
        enabled: true
        priority: 1
      momentum_buying:
        enabled: true
        priority: 2
        min_rsi: 60
      btst:
        enabled: true
        priority: 3
      swing_buying:
        enabled: true
        priority: 4

trade_limits:
  global_max_trades_per_day: 8

# ============================================
# RISK MODEL (NEMESIS V3)
# ============================================
risk:
  sl_pct: 0.30 # 30% fixed SL (entry * 0.70)
  tp_pct: 0.60 # 60% fixed TP (entry * 1.60)

  # Profit protection: Hard stop if HWM reaches threshold and drops by percentage
  profit_protection:
    hwm_threshold_rupees: 1040.0 # Exit if HWM reaches this amount
    drop_pct_from_hwm: 1.0 # Exit if current PnL drops this % from HWM
    enabled: true

  # Micro-Trailing model (tiered)
  trailing_tiers:
    - { trigger_pct: 5, sl_offset_pct: -15 }
    - { trigger_pct: 10, sl_offset_pct: -5 }
    - { trigger_pct: 15, sl_offset_pct: 0 }
    - { trigger_pct: 25, sl_offset_pct: 10 }
    - { trigger_pct: 40, sl_offset_pct: 20 }
    - { trigger_pct: 60, sl_offset_pct: 30 }
    - { trigger_pct: 80, sl_offset_pct: 40 }
    - { trigger_pct: 120, sl_offset_pct: 60 }

  peak_drawdown_exit_pct: 5 # Instant exit on -5% drop from peak
  peak_drawdown_activation_profit_pct: 25.0 # Minimum profit % to activate peak-drawdown gating
  peak_drawdown_activation_sl_offset_pct: 10.0 # Minimum SL offset % to activate peak-drawdown gating

  # Trailing activation: Configurable percentage-based activation threshold
  # Trailing rules (TrailingStopRule, PeakDrawdownRule) only activate when pnl_pct >= this value
  # Based on buy value (premium × lot_size × lots), works across any capital/allocation/lot size
  # Examples: 6.0, 6.66, 9.99, 10.0, 13.32, 15.0, 20.0
  trailing:
    activation_pct: 10.0 # Activate trailing when profit >= 10% of buy value (configurable: 6%, 6.66%, 13.32%, etc.)
    drawdown_pct: 3.0 # Exit if price drops this % from peak (used by trailing rules)

  # Secure profit rule: Lock in profits above threshold while allowing positions to ride
  secure_profit_threshold_rupees: 1000 # Activate tighter protection when profit >= ₹1000
  secure_profit_drawdown_pct: 3.0 # Tighter drawdown threshold (3%) when profit is secured

  # Underlying-aware exit thresholds
  underlying_trend_score_threshold: 10.0 # Exit if underlying trend_score < this value
  underlying_atr_collapse_multiplier: 0.65 # Exit if ATR ratio < this value (falling volatility)

  daily_limits:
    enable: true
    per_index:
      NIFTY: 0.02 # 2% max loss for NIFTY
      BANKNIFTY: 0.04 # 4% max loss for BANKNIFTY
      SENSEX: 0.01 # 1% max loss for SENSEX
    global_limit_pct: 0.04

# ============================================
# SIGNAL SETTINGS
# ============================================
signals:
  primary_timeframe: "1m"
  confirmation_timeframe: "5m"

  # Supertrend+ADX Strategy Configuration
  # By default: 1m Supertrend signal is enabled (no config needed)
  # ADX filter and 5m confirmation are toggleable
  enable_supertrend_signal: true # Enable 1m Supertrend signal (default: true)
  enable_adx_filter: true # Enable ADX strength filter (default: false)
  enable_confirmation_timeframe: true # Enable 5m HTF confirmation (default: false)

  # Modular Indicator System Configuration
  # Use multi_indicator_strategy: true to enable modular indicator system
  # When enabled, the 'indicators' list defines which indicators to use
  use_multi_indicator_strategy: false # Set to true to use modular system

  # Indicator threshold preset: loose, moderate, tight, production
  # - loose: Very permissive - generates more signals for initial testing
  # - moderate: Balanced - good starting point
  # - tight: Strict - fewer but higher quality signals
  # - production: Optimized based on backtesting results
  # Can also be set via ENV['INDICATOR_PRESET']
  indicator_preset: moderate # Options: loose, moderate, tight, production

  confirmation_mode: all # Options: all, majority, weighted, any
  min_confidence: 60 # Minimum combined confidence score (0-100)
  # Note: If indicator_preset is set, these may be overridden by preset values

  # Indicator configurations for modular system
  # Each indicator can be enabled/disabled and configured independently
  indicators:
    - type: supertrend
      enabled: true
      config:
        period: 7
        multiplier: 3.0
        trading_hours_filter: true

    - type: adx
      enabled: true
      config:
        period: 14
        min_strength: 18
        trading_hours_filter: true

    # Example: Add RSI indicator (disabled by default)
    # - type: rsi
    #   enabled: false
    #   config:
    #     period: 14
    #     oversold: 30
    #     overbought: 70
    #     trading_hours_filter: true

    # Example: Add MACD indicator (disabled by default)
    # - type: macd
    #   enabled: false
    #   config:
    #     fast_period: 12
    #     slow_period: 26
    #     signal_period: 9
    #     trading_hours_filter: true

    # Trend Duration Indicator (disabled by default)
    # Uses HMA to detect trend direction and forecast probable trend duration
    # - type: trend_duration
    #   enabled: false
    #   config:
    #     hma_length: 20        # HMA period
    #     trend_length: 5       # Bars to confirm trend (rising/falling)
    #     samples: 10           # Number of historical durations to track
    #     trading_hours_filter: true

  trend_scorer:
    min_trend_score: 14
    mtf_enabled: true

  validation_mode: balanced

  supertrend:
    period: 7
    base_multiplier: 3.0

  adx:
    # Global ADX thresholds (used as fallback if per-index thresholds not specified)
    min_strength: 18 # ADX threshold for 1m timeframe (when enabled)
    confirmation_min_strength: 20 # ADX threshold for 5m confirmation (when enabled)
    # Note: Per-index thresholds in indices[].adx_thresholds override these values

# ============================================
# OPTION CHAIN SETTINGS
# ============================================
chain_analyzer:
  max_candidates: 2
  strike_distance_pct: 0.02
  min_oi: 10000
  min_iv: 5.0
  max_iv: 60.0
  max_spread_pct: 0.03

  scoring_weights:
    oi: 0.4
    spread: 0.25
    iv: 0.2
    volume: 0.15

option_chain:
  min_iv: 10
  max_iv: 60
  min_oi: 50000
  max_spread_pct: 3.0

data_freshness:
  disable_ohlc_caching: false
  disable_option_chain_caching: false
  ohlc_cache_duration_minutes: 5
  option_chain_cache_duration_minutes: 2

# ============================================
# WEBSOCKET WATCHLIST
# ============================================
# WebSocket watchlist for market feed subscription
# Format: Array of strings "SEGMENT:SECURITY_ID" or empty array []
# Example: ["NSE_EQ:11536", "NSE_EQ:11536"]
# Can also be set via ENV['DHANHQ_WS_WATCHLIST'] as fallback
watchlist: []
