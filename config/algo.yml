paper_trading:
  enabled: true
  balance: 100000

# Trading time restrictions based on profitability analysis
# Use analyze_positions_by_time_intervals.rb to identify non-profitable periods
# Format: "HH:MM-HH:MM" (24-hour format, IST timezone)
# Example: ["10:30-11:30", "14:00-15:00"] blocks trading from 10:30 AM to 11:30 AM and 2:00 PM to 3:00 PM
trading_time_restrictions:
  enabled: false # Set to true to enable time-based restrictions
  avoid_periods: [] # Add time periods to avoid (e.g., ["10:30-11:30", "14:00-15:00"])
  # Example based on analysis results:
  # avoid_periods:
  #   - "10:30-11:30"  # Morning non-profitable period
  #   - "14:00-15:00"  # Afternoon non-profitable period

feature_flags:
  enable_direction_before_chain: true
  enable_trend_scorer: false # Toggle TrendScorer on/off (if false, uses legacy Supertrend+ADX path)
  enable_auto_subscribe_unsubscribe: true
  enable_demand_driven_services: true
  enable_underlying_aware_exits: false
  enable_peak_drawdown_activation: false
  auto_paper_on_insufficient_balance: false

# ============================================
# INDEX CONFIG (TREND-SCORE DRIVEN)
# ============================================
indices:
  - key: NIFTY
    segment: IDX_I
    sid: "13"
    capital_alloc_pct: 0.30
    max_same_side: 1
    cooldown_sec: 180
    direction: bullish

    premium_band:
      min: 30
      max: 120

    otm_rules:
      max_otm: 2 # ATM → +1 OTM → +2 OTM

    risk_model:
      base_risk_pct: 0.01 # 1% base
      strong_trend_pct: 0.01
      weak_trend_pct: 0.005

    trade_limits:
      max_trades_per_day: 3

    # Per-index ADX thresholds (overrides global if specified)
    adx_thresholds:
      primary_min_strength: 14 # 1m ADX threshold (70% of typical ~20)
      confirmation_min_strength: 11 # 5m ADX threshold (70% of typical ~15.5)

    strategies:
      open_interest:
        enabled: true
        priority: 1
      momentum_buying:
        enabled: true
        priority: 2
        min_rsi: 60
      btst:
        enabled: true
        priority: 3
      swing_buying:
        enabled: true
        priority: 4

  - key: BANKNIFTY
    segment: IDX_I
    sid: "25"
    capital_alloc_pct: 0.30
    max_same_side: 1
    cooldown_sec: 180
    direction: bullish

    premium_band:
      min: 60
      max: 180

    otm_rules:
      max_otm: 2

    risk_model:
      base_risk_pct: 0.02 # 2% base
      strong_trend_pct: 0.02
      weak_trend_pct: 0.01

    trade_limits:
      max_trades_per_day: 1

    # Per-index ADX thresholds (overrides global if specified)
    adx_thresholds:
      primary_min_strength: 10 # 1m ADX threshold (use global default)
      confirmation_min_strength: 15 # 5m ADX threshold (70% of typical ~44)

    strategies:
      open_interest:
        enabled: true
        priority: 1
      momentum_buying:
        enabled: true
        priority: 2
        min_rsi: 60
      btst:
        enabled: true
        priority: 3
      swing_buying:
        enabled: true
        priority: 4

  - key: SENSEX
    segment: IDX_I
    sid: "51"
    capital_alloc_pct: 0.30
    max_same_side: 1
    cooldown_sec: 180
    direction: bullish

    premium_band:
      min: 40
      max: 150

    otm_rules:
      max_otm: 2

    risk_model:
      base_risk_pct: 0.005 # 0.5% base
      strong_trend_pct: 0.005
      weak_trend_pct: 0.0025

    trade_limits:
      max_trades_per_day: 2

    # Per-index ADX thresholds (overrides global if specified)
    adx_thresholds:
      primary_min_strength: 10 # 1m ADX threshold (70% of typical ~25.5)
      confirmation_min_strength: 10 # 5m ADX threshold (70% of typical ~13.5)

    strategies:
      open_interest:
        enabled: true
        priority: 1
      momentum_buying:
        enabled: true
        priority: 2
        min_rsi: 60
      btst:
        enabled: true
        priority: 3
      swing_buying:
        enabled: true
        priority: 4

trade_limits:
  global_max_trades_per_day: 8

# ============================================
# RISK MODEL (NEMESIS V3)
# ============================================
risk:
  sl_pct: 0.30 # 30% fixed SL (entry * 0.70)
  tp_pct: 0.60 # 60% fixed TP (entry * 1.60)

  # Profit protection: Hard stop if HWM reaches threshold and drops by percentage
  profit_protection:
    hwm_threshold_rupees: 1040.0 # Exit if HWM reaches this amount
    drop_pct_from_hwm: 1.0 # Exit if current PnL drops this % from HWM
    enabled: true

  # Trailing stop mode: 'tiered' (fixed tiers) or 'direct' (follows price directly)
  trailing_mode: direct # Options: 'tiered' or 'direct'

  # Direct trailing stop configuration (when trailing_mode: 'direct')
  # SL moves directly with price, maintaining fixed distance below current price
  # Only moves upward - never moves down
  direct_trailing:
    enabled: true # Enable direct trailing stop
    distance_pct: 5.0 # Distance below current price (e.g., 5% = SL at 95% of current price)
    activation_profit_pct: 0.0 # Minimum profit % before activating (0 = immediate activation)
    min_sl_offset_pct: -30.0 # Minimum SL offset from entry (prevents SL from going below initial SL)

  # Micro-Trailing model (tiered) - 3% INTERVALS with CONSERVATIVE SL offsets
  # More granular tiers with tighter protection to minimize losses
  # Used when trailing_mode: 'tiered'
  trailing_tiers:
    - { trigger_pct: 3, sl_offset_pct: -15 } # 3%: -15% SL (wide stop, early stage)
    - { trigger_pct: 6, sl_offset_pct: -10 } # 6%: -10% SL (gradual tightening)
    - { trigger_pct: 9, sl_offset_pct: -5 } # 9%: -5% SL (approaching breakeven)
    - { trigger_pct: 12, sl_offset_pct: -2 } # 12%: -2% SL (close to breakeven)
    - { trigger_pct: 15, sl_offset_pct: 0 } # 15%: 0% SL (breakeven locked)
    - { trigger_pct: 18, sl_offset_pct: 2 } # 18%: +2% SL (small profit protection)
    - { trigger_pct: 21, sl_offset_pct: 3 } # 21%: +3% SL (tighter than old +5%)
    - { trigger_pct: 24, sl_offset_pct: 4 } # 24%: +4% SL (gradual increase)
    - { trigger_pct: 27, sl_offset_pct: 5 } # 27%: +5% SL (conservative)
    - { trigger_pct: 30, sl_offset_pct: 6 } # 30%: +6% SL
    - { trigger_pct: 33, sl_offset_pct: 8 } # 33%: +8% SL
    - { trigger_pct: 36, sl_offset_pct: 10 } # 36%: +10% SL
    - { trigger_pct: 39, sl_offset_pct: 12 } # 39%: +12% SL
    - { trigger_pct: 42, sl_offset_pct: 15 } # 42%: +15% SL
    - { trigger_pct: 45, sl_offset_pct: 18 } # 45%: +18% SL
    - { trigger_pct: 48, sl_offset_pct: 20 } # 48%: +20% SL
    - { trigger_pct: 51, sl_offset_pct: 22 } # 51%: +22% SL
    - { trigger_pct: 54, sl_offset_pct: 25 } # 54%: +25% SL
    - { trigger_pct: 57, sl_offset_pct: 28 } # 57%: +28% SL
    - { trigger_pct: 60, sl_offset_pct: 30 } # 60%: +30% SL
    - { trigger_pct: 63, sl_offset_pct: 32 } # 63%: +32% SL
    - { trigger_pct: 66, sl_offset_pct: 35 } # 66%: +35% SL
    - { trigger_pct: 69, sl_offset_pct: 38 } # 69%: +38% SL
    - { trigger_pct: 72, sl_offset_pct: 40 } # 72%: +40% SL
    - { trigger_pct: 75, sl_offset_pct: 42 } # 75%: +42% SL
    - { trigger_pct: 78, sl_offset_pct: 45 } # 78%: +45% SL
    - { trigger_pct: 81, sl_offset_pct: 48 } # 81%: +48% SL
    - { trigger_pct: 84, sl_offset_pct: 50 } # 84%: +50% SL
    - { trigger_pct: 87, sl_offset_pct: 52 } # 87%: +52% SL
    - { trigger_pct: 90, sl_offset_pct: 55 } # 90%: +55% SL
    - { trigger_pct: 93, sl_offset_pct: 58 } # 93%: +58% SL
    - { trigger_pct: 96, sl_offset_pct: 60 } # 96%: +60% SL
    - { trigger_pct: 99, sl_offset_pct: 62 } # 99%: +62% SL
    - { trigger_pct: 102, sl_offset_pct: 65 } # 102%: +65% SL
    - { trigger_pct: 105, sl_offset_pct: 68 } # 105%: +68% SL
    - { trigger_pct: 108, sl_offset_pct: 70 } # 108%: +70% SL
    - { trigger_pct: 111, sl_offset_pct: 72 } # 111%: +72% SL
    - { trigger_pct: 114, sl_offset_pct: 75 } # 114%: +75% SL
    - { trigger_pct: 117, sl_offset_pct: 78 } # 117%: +78% SL
    - { trigger_pct: 120, sl_offset_pct: 80 } # 120%: +80% SL

  # Peak drawdown protection - OPTIMIZED for tighter protection
  peak_drawdown_exit_pct: 3 # Base threshold (reduced from 5% to 3%)
  # Dynamic drawdown thresholds based on profit level (tighter for lower profits)
  dynamic_drawdown_thresholds:
    low_profit: 2.0 # <10% profit: 2% drawdown (very tight)
    medium_profit: 3.0 # 10-25% profit: 3% drawdown (tight)
    high_profit: 5.0 # >25% profit: 5% drawdown (standard)
  # Capital-based drawdown thresholds (tighter for larger positions to ensure profit)
  # Ensures larger positions close profitably - 1% drop on ₹50k = ₹500 vs ₹20k = ₹200
  capital_based_thresholds:
    small_capital: # < ₹30,000
      max_capital: 30000
      low_profit: 2.0 # <10% profit: 2% drawdown
      medium_profit: 3.0 # 10-25% profit: 3% drawdown
      high_profit: 5.0 # >25% profit: 5% drawdown
    medium_capital: # ₹30,000 - ₹50,000
      min_capital: 30000
      max_capital: 50000
      low_profit: 1.5 # <10% profit: 1.5% drawdown (tighter)
      medium_profit: 2.0 # 10-25% profit: 2% drawdown (tighter)
      high_profit: 3.0 # >25% profit: 3% drawdown (tighter)
    large_capital: # > ₹50,000
      min_capital: 50000
      low_profit: 1.0 # <10% profit: 1% drawdown (very tight)
      medium_profit: 1.5 # 10-25% profit: 1.5% drawdown (very tight)
      high_profit: 2.0 # >25% profit: 2% drawdown (very tight)
  peak_drawdown_activation_profit_pct: 10.0 # Reduced from 25.0 (activate earlier)
  peak_drawdown_activation_sl_offset_pct: 5.0 # Reduced from 10.0 (activate with lower SL offset)

  # Trailing activation: Configurable percentage-based activation threshold
  # Trailing rules (TrailingStopRule, PeakDrawdownRule) only activate when pnl_pct >= this value
  # Based on buy value (premium × lot_size × lots), works across any capital/allocation/lot size
  # Examples: 6.0, 6.66, 9.99, 10.0, 13.32, 15.0, 20.0
  trailing:
    activation_pct: 10.0 # Activate trailing when profit >= 10% of buy value (configurable: 6%, 6.66%, 13.32%, etc.)
    drawdown_pct: 3.0 # Exit if price drops this % from peak (used by trailing rules)

  # Secure profit rule: Lock in profits above threshold while allowing positions to ride
  secure_profit_threshold_rupees: 1000 # Activate tighter protection when profit >= ₹1000
  secure_profit_drawdown_pct: 3.0 # Tighter drawdown threshold (3%) when profit is secured

  # Underlying-aware exit thresholds
  underlying_trend_score_threshold: 10.0 # Exit if underlying trend_score < this value
  underlying_atr_collapse_multiplier: 0.65 # Exit if ATR ratio < this value (falling volatility)

  daily_limits:
    enable: true
    per_index:
      NIFTY: 0.02 # 2% max loss for NIFTY
      BANKNIFTY: 0.04 # 4% max loss for BANKNIFTY
      SENSEX: 0.01 # 1% max loss for SENSEX
    global_limit_pct: 0.04

# ============================================
# SIGNAL SETTINGS
# ============================================
signals:
  primary_timeframe: "1m"
  confirmation_timeframe: "5m"

  # NoTradeEngine Configuration
  # Set to false to disable both Phase 1 (pre-check) and Phase 2 (detailed validation)
  # Useful for testing the trading system without NoTradeEngine restrictions
  enable_no_trade_engine: false # Enable NoTradeEngine validation (default: true)

  # Supertrend+ADX Strategy Configuration
  # By default: 1m Supertrend signal is enabled (no config needed)
  # ADX filter and 5m confirmation are toggleable
  enable_supertrend_signal: true # Enable 1m Supertrend signal (default: true)
  enable_adx_filter: true # Enable ADX strength filter (default: false)
  enable_confirmation_timeframe: true # Enable 5m HTF confirmation (default: false)

  # Modular Indicator System Configuration
  # Use multi_indicator_strategy: true to enable modular indicator system
  # When enabled, the 'indicators' list defines which indicators to use
  use_multi_indicator_strategy: false # Set to true to use modular system

  # Indicator threshold preset: loose, moderate, tight, production
  # - loose: Very permissive - generates more signals for initial testing
  # - moderate: Balanced - good starting point
  # - tight: Strict - fewer but higher quality signals
  # - production: Optimized based on backtesting results
  # Can also be set via ENV['INDICATOR_PRESET']
  indicator_preset: moderate # Options: loose, moderate, tight, production

  confirmation_mode: all # Options: all, majority, weighted, any
  min_confidence: 60 # Minimum combined confidence score (0-100)
  # Note: If indicator_preset is set, these may be overridden by preset values

  # Indicator configurations for modular system
  # Each indicator can be enabled/disabled and configured independently
  indicators:
    - type: supertrend
      enabled: true
      config:
        period: 7
        multiplier: 3.0
        trading_hours_filter: true

    - type: adx
      enabled: true
      config:
        period: 14
        min_strength: 10
        trading_hours_filter: true

    # Example: Add RSI indicator (disabled by default)
    # - type: rsi
    #   enabled: false
    #   config:
    #     period: 14
    #     oversold: 30
    #     overbought: 70
    #     trading_hours_filter: true

    # Example: Add MACD indicator (disabled by default)
    # - type: macd
    #   enabled: false
    #   config:
    #     fast_period: 12
    #     slow_period: 26
    #     signal_period: 9
    #     trading_hours_filter: true

    # Trend Duration Indicator (disabled by default)
    # Uses HMA to detect trend direction and forecast probable trend duration
    # - type: trend_duration
    #   enabled: false
    #   config:
    #     hma_length: 20        # HMA period
    #     trend_length: 5       # Bars to confirm trend (rising/falling)
    #     samples: 10           # Number of historical durations to track
    #     trading_hours_filter: true

  trend_scorer:
    min_trend_score: 14
    mtf_enabled: true

  validation_mode: balanced

  supertrend:
    period: 7
    base_multiplier: 3.0

  adx:
    # Global ADX thresholds (used as fallback if per-index thresholds not specified)
    min_strength: 10 # ADX threshold for 1m timeframe (when enabled)
    confirmation_min_strength: 15 # ADX threshold for 5m confirmation (when enabled)
    # Note: Per-index thresholds in indices[].adx_thresholds override these values

# ============================================
# OPTION CHAIN SETTINGS
# ============================================
chain_analyzer:
  max_candidates: 2
  strike_distance_pct: 0.02
  min_oi: 10000
  min_iv: 5.0
  max_iv: 60.0
  max_spread_pct: 0.03

  scoring_weights:
    oi: 0.4
    spread: 0.25
    iv: 0.2
    volume: 0.15

option_chain:
  min_iv: 10
  max_iv: 60
  min_oi: 50000
  max_spread_pct: 3.0

data_freshness:
  disable_ohlc_caching: false
  disable_option_chain_caching: false
  ohlc_cache_duration_minutes: 5
  option_chain_cache_duration_minutes: 2

# ============================================
# WEBSOCKET WATCHLIST
# ============================================
# WebSocket watchlist for market feed subscription
# Format: Array of strings "SEGMENT:SECURITY_ID" or empty array []
# Example: ["NSE_EQ:11536", "NSE_EQ:11536"]
# Can also be set via ENV['DHANHQ_WS_WATCHLIST'] as fallback
watchlist: []
